value <- list(mod5 = ta$value %% 500 == 0, mod50 = ta$value %% 5000 == 0, mod100 = ta$value %% 10000 == 0, ge100 = ta$value >= 10000)
# return feature list and abt
feats <- c( "payor_country", "payee_country", "payor_bank", "payee_bank", "payor_owner", "payee_owner", "payor_pa", "payee_pa",
"reference", "entry", "value")
features <- data.frame( name = unlist(lapply( feats, function(x) rep(x, length(get(x, envir = env))) )),
value = unlist(lapply( feats, function(x) names(get(x, envir = env)) )) )
abt <- do.call(cbind, unlist(lapply(feats, get, envir = env), recursive = FALSE))
colnames(abt) <- paste(features$name, features$value, sep = ":")
mode(abt) <- "integer"
class(abt) <- "ABT"
class(features) <- "FeatureList"
return(list(ABT = abt, FeatureList = features))
}
res <- FeatureExtraction(df, df2)
FeatureExtraction <- function( ta, pa )
{
env <- environment()
# country code
x <- sort(unique(strtrim(gsub("[^0-9a-z]", "", tolower(ta$payor_iban)), width = 2)))
payor_country <- lapply(x, function(x) grepl(x, gsub("[^0-9a-z]", "", tolower(ta$payor_iban))))
names(payor_country) <- x
x <- sort(unique(strtrim(gsub("[^0-9a-z]", "", tolower(ta$payee_iban)), width = 2)))
payee_country <- lapply(x, function(x) grepl(x, gsub("[^0-9a-z]", "", tolower(ta$payee_iban))))
names(payee_country) <- x
# bank code
x <- sort(unique(strtrim(gsub("[^0-9a-z]", "", tolower(ta$payor_bic)), width = 4)))
payor_bank <- lapply(x, function(x) grepl(x, gsub("[^0-9a-z]", "", tolower(ta$payor_bic))))
names(payor_bank) <- x
x <- sort(unique(strtrim(gsub("[^0-9a-z]", "", tolower(ta$payee_bic)), width = 4)))
payee_bank <- lapply(x, function(x) grepl(x, gsub("[^0-9a-z]", "", tolower(ta$payee_bic))))
names(payee_bank) <- x
# owners
x <- sort(unique(gsub("[^a-z0-9]", "", tolower(ta$payor_owner))))
payor_owner <- lapply(x, function(x) grepl(tolower(x), gsub("[^a-z 0-9]", "", tolower(ta$payor_owner))))
names(payor_owner) <- x
x <- sort(unique(gsub("[^a-z0-9]", "", tolower(ta$payee_owner))))
payee_owner <- lapply(x, function(x) grepl(tolower(x), gsub("[^a-z 0-9]", "", tolower(ta$payee_owner))))
names(payee_owner) <- x
# own accounts
x <- sort(unique(pa$account_id[pa$account_id %in% ta$payor_id]))
payor_pa <- lapply(x, function(x) x == ta$payor_id)
names(payor_pa) <- x
x <- sort(unique(pa$account_id[pa$account_id %in% ta$payee_id]))
payee_pa <- lapply(x, function(x) x == ta$payee_id)
names(payee_pa) <- x
# reference
reference <- gsub("[^a-z ]", "", tolower(ta$reference))
x <- sort(unique(unlist(strsplit(reference, " "))))
reference <- lapply(x, function(x) grepl(x, reference))
names(reference) <- x
# entry
entry <- gsub("[^a-z ]", "", tolower(ta$entry))
x <- sort(unique(unlist(strsplit(entry, " "))))
entry <- lapply(x, function(x) grepl(x, entry))
names(entry) <- x
# value
ta$value <- as.integer(ta$value)
value <- list(mod5 = ta$value %% 500 == 0, mod50 = ta$value %% 5000 == 0, mod100 = ta$value %% 10000 == 0, ge100 = ta$value >= 10000)
# return feature list and abt
feats <- c( "payor_country", "payee_country", "payor_bank", "payee_bank", "payor_owner", "payee_owner", "payor_pa", "payee_pa",
"reference", "entry", "value")
features <- data.frame( name = unlist(lapply( feats, function(x) rep(x, length(get(x, envir = env))) )),
value = unlist(lapply( feats, function(x) names(get(x, envir = env)) )) )
abt <- do.call(cbind, unlist(lapply(feats, get, envir = env), recursive = FALSE))
colnames(abt) <- paste(features$name, features$value, sep = ":")
mode(abt) <- "integer"
class(abt) <- "ABT"
class(features) <- "FeatureList"
return(list(ABT = abt, FeatureList = features))
}
df <- data.frame(
payor_id = 1:4, payor_owner = rep("a\\s[] d:.", 4), payor_iban = c("D\\E000342", "ENasd/;:.,", "es1234", "_d-#üäeö"), payor_bic = rep("as\\Df_`\\[]{}()"),
payee_id = 4:1, payee_owner = rep("a\\s[] d:.", 4), payee_iban = c("DE000342", "EN\\[]{}/()", "es1234", "d_e1~*#!$%"), payee_bic = rep("asDf&^°|<>"),
date = c("2010-1-1", "2010-01-01", "1990-1-1", "1990-01-01"),
reference = c("as_d üäö:,|as\\d_%&/´", "t_e;üsö:,|t\\_%$§/´", "test test", "asd"),
entry = c("as#'d üäö:^°as\\d_%&/´", "t_e(;))üsö:,|t\\_%$[§]/´", "test te{s}\t", "asd"),
value = c("500", "10000", "50219", "0")
)
df2 <- data.frame(account_id = 1)
res <- FeatureExtraction(df, df2)
colnames(res$ABT)
grepl(res$FeatureList$name, "country")
grepl("country", res$FeatureList$name)
feats$value[grepl("country", feats$name)]
feats <- res$FeatureList
feats$value[grepl("country", feats$name)]
unique(feats$value[grepl("country", feats$name)])
unique(feats$value[grepl("country", feats$name)]) == c("de", "en", "es")
library(testthat)
expect_equal(unique(feats$value[grepl("country", feats$name)]), c("de", "en", "es"))
expect_equal(unique(feats$value[grepl("country", feats$name)]), factor(c("de", "en", "es")))
expect_true(unique(feats$value[grepl("country", feats$name)]) == c("de", "en", "es"))
unique(feats$value[grepl("country", feats$name)]) == c("de", "en", "es")
expect_true(as.character(unique(feats$value[grepl("country", feats$name)])) == c("de", "en", "es"))
expect_true(as.character(unique(feats$value[grepl("country", feats$name)])), c("de", "en", "es"))
as.character(unique(feats$value[grepl("country", feats$name)]))
c("de", "en", "es")
expect_true(as.character(unique(feats$value[grepl("country", feats$name)])), c("de", "en", "es"))
expect_equal(as.character(unique(feats$value[grepl("country", feats$name)])), c("de", "en", "es"))
expect_equal(as.character(unique(feats$value[grepl("country", feats$name)])), c("de", "en", "ed"))
colnames(res$ABT)
expect_equal(as.character(unique(feats$value[grepl("owner", feats$name)])), "asd")
expect_equal(as.character(unique(feats$value[grepl("owner", feats$name)])), "asdf")
expect_equal(as.character(unique(feats$value[grepl("bank", feats$name)])), "asdf")
df <- data.frame(
payor_id = 1:4, payor_owner = rep("a\\s[] d:.", 4), payor_iban = c("D\\E000342", "ENasd/;:.,", "es1234", "_d-#üäeö"), payor_bic = rep("as\\Df_`\\[]{}()"),
payee_id = 4:1, payee_owner = rep("a\\s[] d:.", 4), payee_iban = c("DE000342", "EN\\[]{}/()", "es1234", "d_e1~*#!$%"), payee_bic = rep("asDf&^°|<>"),
date = c("2010-1-1", "2010-01-01", "1990-1-1", "1990-01-01"),
reference = c("as_d üäö:,|as\\d_%&/´", "t_e;üsö:,|t\\_%$§/´", "test test", "asd"),
entry = c("as#'d üäö:^°as\\d_%&/´", "t_e(;))üsö:t,|t\\_%$[§]/´", "test te{s}\t", "asd"),
value = c("500", "10000", "50219", "0")
)
res <- FeatureExtraction(df, df2)
feats <- res$FeatureList
colnames(res$ABT)
FeatureExtraction <- function( ta, pa )
{
env <- environment()
# country code
x <- sort(unique(strtrim(gsub("[^0-9a-z]", "", tolower(ta$payor_iban)), width = 2)))
payor_country <- lapply(x, function(x) grepl(x, gsub("[^0-9a-z]", "", tolower(ta$payor_iban))))
names(payor_country) <- x
x <- sort(unique(strtrim(gsub("[^0-9a-z]", "", tolower(ta$payee_iban)), width = 2)))
payee_country <- lapply(x, function(x) grepl(x, gsub("[^0-9a-z]", "", tolower(ta$payee_iban))))
names(payee_country) <- x
# bank code
x <- sort(unique(strtrim(gsub("[^0-9a-z]", "", tolower(ta$payor_bic)), width = 4)))
payor_bank <- lapply(x, function(x) grepl(x, gsub("[^0-9a-z]", "", tolower(ta$payor_bic))))
names(payor_bank) <- x
x <- sort(unique(strtrim(gsub("[^0-9a-z]", "", tolower(ta$payee_bic)), width = 4)))
payee_bank <- lapply(x, function(x) grepl(x, gsub("[^0-9a-z]", "", tolower(ta$payee_bic))))
names(payee_bank) <- x
# owners
x <- sort(unique(gsub("[^a-z0-9]", "", tolower(ta$payor_owner))))
payor_owner <- lapply(x, function(x) grepl(tolower(x), gsub("[^a-z 0-9]", "", tolower(ta$payor_owner))))
names(payor_owner) <- x
x <- sort(unique(gsub("[^a-z0-9]", "", tolower(ta$payee_owner))))
payee_owner <- lapply(x, function(x) grepl(tolower(x), gsub("[^a-z 0-9]", "", tolower(ta$payee_owner))))
names(payee_owner) <- x
# own accounts
x <- sort(unique(pa$account_id[pa$account_id %in% ta$payor_id]))
payor_pa <- lapply(x, function(x) x == ta$payor_id)
names(payor_pa) <- x
x <- sort(unique(pa$account_id[pa$account_id %in% ta$payee_id]))
payee_pa <- lapply(x, function(x) x == ta$payee_id)
names(payee_pa) <- x
# reference
reference <- gsub("[^a-z ]", "", tolower(ta$reference))
x <- sort(unique(unlist(strsplit(reference, " "))))
reference <- lapply(x, function(x) grepl(x, reference))
names(reference) <- x
# entry
entry <- gsub("[^a-z ]", "", tolower(ta$entry))
x <- sort(unique(unlist(strsplit(entry, " "))))
entry <- lapply(x, function(x) grepl(x, entry))
names(entry) <- x
# value
ta$value <- as.integer(ta$value)
value <- list(mod5 = ta$value %% 500 == 0, mod50 = ta$value %% 5000 == 0, mod100 = ta$value %% 10000 == 0, ge100 = ta$value >= 10000)
# return feature list and abt
feats <- c( "payor_country", "payee_country", "payor_bank", "payee_bank", "payor_owner", "payee_owner", "payor_pa", "payee_pa",
"reference", "entry", "value")
features <- data.frame( name = unlist(lapply( feats, function(x) rep(x, length(get(x, envir = env))) )),
value = unlist(lapply( feats, function(x) names(get(x, envir = env)) )) )
abt <- do.call(cbind, unlist(lapply(feats, get, envir = env), recursive = FALSE))
colnames(abt) <- paste(features$name, features$value, sep = ":")
mode(abt) <- "integer"
class(abt) <- "ABT"
class(features) <- "FeatureList"
return(list(ABT = abt, FeatureList = features))
}
res <- FeatureExtraction(df, df2)
feats <- res$FeatureList
colnames(res$ABT)
df <- data.frame(
payor_id = 1:4, payor_owner = rep("a\\s[] d:.", 4), payor_iban = c("D\\E000342", "ENasd/;:.,", "es1234", "_d-#üäeö"), payor_bic = rep("as\\Df_`\\[]{}()"),
payee_id = 4:1, payee_owner = rep("a\\s[] d:.", 4), payee_iban = c("DE000342", "EN\\[]{}/()", "es1234", "d_e1~*#!$%"), payee_bic = rep("asDf&^°|<>"),
date = c("2010-1-1", "2010-01-01", "1990-1-1", "1990-01-01"),
reference = c("as_d üäö:,|as\\d_%&/´", "t_e;üsö:,|t\\_%$§/´", "test test", "asd"),
entry = c("as#'d üäö:^°as\\d_%&/´", "t_e(;))üsö:,|t\\_%$[§]/´", "test te{s}\\t", "asd"),
value = c("500", "10000", "50219", "0")
)
res <- FeatureExtraction(df, df2)
feats <- res$FeatureList
colnames(res$ABT)
expect_equal(as.character(unique(feats$value[grepl("reference", feats$name)])), c("asd", "test"))
expect_equal(as.character(unique(feats$value[grepl("entry", feats$name)])), c("asd", "test"))
abt <- res$ABT
abt
as.matrix(abt)
prmatrix(abt)
colnames(abt) <- NULL
abt
FeatureExtraction <- function( ta, pa )
{
env <- environment()
# country code
x <- sort(unique(strtrim(gsub("[^0-9a-z]", "", tolower(ta$payor_iban)), width = 2)))
payor_country <- lapply(x, function(x) grepl(x, gsub("[^0-9a-z]", "", tolower(ta$payor_iban))))
names(payor_country) <- x
x <- sort(unique(strtrim(gsub("[^0-9a-z]", "", tolower(ta$payee_iban)), width = 2)))
payee_country <- lapply(x, function(x) grepl(x, gsub("[^0-9a-z]", "", tolower(ta$payee_iban))))
names(payee_country) <- x
# bank code
x <- sort(unique(strtrim(gsub("[^0-9a-z]", "", tolower(ta$payor_bic)), width = 4)))
payor_bank <- lapply(x, function(x) grepl(x, gsub("[^0-9a-z]", "", tolower(ta$payor_bic))))
names(payor_bank) <- x
x <- sort(unique(strtrim(gsub("[^0-9a-z]", "", tolower(ta$payee_bic)), width = 4)))
payee_bank <- lapply(x, function(x) grepl(x, gsub("[^0-9a-z]", "", tolower(ta$payee_bic))))
names(payee_bank) <- x
# owners
x <- sort(unique(gsub("[^a-z0-9 ]", "", tolower(ta$payor_owner))))
payor_owner <- lapply(x, function(x) grepl(tolower(x), gsub("[^a-z 0-9]", "", tolower(ta$payor_owner))))
names(payor_owner) <- x
x <- sort(unique(gsub("[^a-z0-9 ]", "", tolower(ta$payee_owner))))
payee_owner <- lapply(x, function(x) grepl(tolower(x), gsub("[^a-z 0-9]", "", tolower(ta$payee_owner))))
names(payee_owner) <- x
# own accounts
x <- sort(unique(pa$account_id[pa$account_id %in% ta$payor_id]))
payor_pa <- lapply(x, function(x) x == ta$payor_id)
names(payor_pa) <- x
x <- sort(unique(pa$account_id[pa$account_id %in% ta$payee_id]))
payee_pa <- lapply(x, function(x) x == ta$payee_id)
names(payee_pa) <- x
# reference
reference <- gsub("[^a-z ]", "", tolower(ta$reference))
x <- sort(unique(unlist(strsplit(reference, " "))))
reference <- lapply(x, function(x) grepl(x, reference))
names(reference) <- x
# entry
entry <- gsub("[^a-z ]", "", tolower(ta$entry))
x <- sort(unique(unlist(strsplit(entry, " "))))
entry <- lapply(x, function(x) grepl(x, entry))
names(entry) <- x
# value
ta$value <- as.integer(ta$value)
value <- list(mod5 = ta$value %% 500 == 0, mod50 = ta$value %% 5000 == 0, mod100 = ta$value %% 10000 == 0, ge100 = ta$value >= 10000)
# return feature list and abt
feats <- c( "payor_country", "payee_country", "payor_bank", "payee_bank", "payor_owner", "payee_owner", "payor_pa", "payee_pa",
"reference", "entry", "value")
features <- data.frame( name = unlist(lapply( feats, function(x) rep(x, length(get(x, envir = env))) )),
value = unlist(lapply( feats, function(x) names(get(x, envir = env)) )) )
abt <- do.call(cbind, unlist(lapply(feats, get, envir = env), recursive = FALSE))
colnames(abt) <- paste(features$name, features$value, sep = ":")
mode(abt) <- "integer"
class(abt) <- "ABT"
class(features) <- "FeatureList"
return(list(ABT = abt, FeatureList = features))
}
res <- FeatureExtraction(df, df2)
feats <- res$FeatureList
abt <- res$ABT
abt
exp <- cbind(c(1,0,0,1), c(0,1,0,0), c(0,0,1))
as.integer(c("500", "10000"))
as.integer(c("500", "10000"))%%500
a <- c("500", "10000")
a <- as.integer(a)
list(mod5 = a %% 500)
list(mod5 = a %% 500 == 0)
list(mod5 = a %% 500 == 0, mod100 = a %% 10000 == 0)
b <- list(mod5 = a %% 500 == 0, mod100 = a %% 10000 == 0)
b
FeatureExtraction <- function( ta, pa )
{
env <- environment()
# country code
x <- sort(unique(strtrim(gsub("[^0-9a-z]", "", tolower(ta$payor_iban)), width = 2)))
payor_country <- lapply(x, function(x) grepl(x, gsub("[^0-9a-z]", "", tolower(ta$payor_iban))))
names(payor_country) <- x
x <- sort(unique(strtrim(gsub("[^0-9a-z]", "", tolower(ta$payee_iban)), width = 2)))
payee_country <- lapply(x, function(x) grepl(x, gsub("[^0-9a-z]", "", tolower(ta$payee_iban))))
names(payee_country) <- x
# bank code
x <- sort(unique(strtrim(gsub("[^0-9a-z]", "", tolower(ta$payor_bic)), width = 4)))
payor_bank <- lapply(x, function(x) grepl(x, gsub("[^0-9a-z]", "", tolower(ta$payor_bic))))
names(payor_bank) <- x
x <- sort(unique(strtrim(gsub("[^0-9a-z]", "", tolower(ta$payee_bic)), width = 4)))
payee_bank <- lapply(x, function(x) grepl(x, gsub("[^0-9a-z]", "", tolower(ta$payee_bic))))
names(payee_bank) <- x
# owners
x <- sort(unique(gsub("[^a-z0-9 ]", "", tolower(ta$payor_owner))))
payor_owner <- lapply(x, function(x) grepl(tolower(x), gsub("[^a-z 0-9]", "", tolower(ta$payor_owner))))
names(payor_owner) <- x
x <- sort(unique(gsub("[^a-z0-9 ]", "", tolower(ta$payee_owner))))
payee_owner <- lapply(x, function(x) grepl(tolower(x), gsub("[^a-z 0-9]", "", tolower(ta$payee_owner))))
names(payee_owner) <- x
# own accounts
x <- sort(unique(pa$account_id[pa$account_id %in% ta$payor_id]))
payor_pa <- lapply(x, function(x) x == ta$payor_id)
names(payor_pa) <- x
x <- sort(unique(pa$account_id[pa$account_id %in% ta$payee_id]))
payee_pa <- lapply(x, function(x) x == ta$payee_id)
names(payee_pa) <- x
# reference
reference <- gsub("[^a-z ]", "", tolower(ta$reference))
x <- sort(unique(unlist(strsplit(reference, " "))))
reference <- lapply(x, function(x) grepl(x, reference))
names(reference) <- x
# entry
entry <- gsub("[^a-z ]", "", tolower(ta$entry))
x <- sort(unique(unlist(strsplit(entry, " "))))
entry <- lapply(x, function(x) grepl(x, entry))
names(entry) <- x
# value
ta$value <- as.integer(ta$value)
value <- list(mod5 = ta$value %% 500 == 0, mod50 = ta$value %% 5000 == 0, mod100 = ta$value %% 10000 == 0, ge100 = ta$value >= 10000)
return(value)
# return feature list and abt
feats <- c( "payor_country", "payee_country", "payor_bank", "payee_bank", "payor_owner", "payee_owner", "payor_pa", "payee_pa",
"reference", "entry", "value")
features <- data.frame( name = unlist(lapply( feats, function(x) rep(x, length(get(x, envir = env))) )),
value = unlist(lapply( feats, function(x) names(get(x, envir = env)) )) )
abt <- do.call(cbind, unlist(lapply(feats, get, envir = env), recursive = FALSE))
colnames(abt) <- paste(features$name, features$value, sep = ":")
mode(abt) <- "integer"
class(abt) <- "ABT"
class(features) <- "FeatureList"
return(list(ABT = abt, FeatureList = features))
}
res <- FeatureExtraction(df, df2)
res
FeatureExtraction <- function( ta, pa )
{
env <- environment()
# country code
x <- sort(unique(strtrim(gsub("[^0-9a-z]", "", tolower(ta$payor_iban)), width = 2)))
payor_country <- lapply(x, function(x) grepl(x, gsub("[^0-9a-z]", "", tolower(ta$payor_iban))))
names(payor_country) <- x
x <- sort(unique(strtrim(gsub("[^0-9a-z]", "", tolower(ta$payee_iban)), width = 2)))
payee_country <- lapply(x, function(x) grepl(x, gsub("[^0-9a-z]", "", tolower(ta$payee_iban))))
names(payee_country) <- x
# bank code
x <- sort(unique(strtrim(gsub("[^0-9a-z]", "", tolower(ta$payor_bic)), width = 4)))
payor_bank <- lapply(x, function(x) grepl(x, gsub("[^0-9a-z]", "", tolower(ta$payor_bic))))
names(payor_bank) <- x
x <- sort(unique(strtrim(gsub("[^0-9a-z]", "", tolower(ta$payee_bic)), width = 4)))
payee_bank <- lapply(x, function(x) grepl(x, gsub("[^0-9a-z]", "", tolower(ta$payee_bic))))
names(payee_bank) <- x
# owners
x <- sort(unique(gsub("[^a-z0-9 ]", "", tolower(ta$payor_owner))))
payor_owner <- lapply(x, function(x) grepl(tolower(x), gsub("[^a-z 0-9]", "", tolower(ta$payor_owner))))
names(payor_owner) <- x
x <- sort(unique(gsub("[^a-z0-9 ]", "", tolower(ta$payee_owner))))
payee_owner <- lapply(x, function(x) grepl(tolower(x), gsub("[^a-z 0-9]", "", tolower(ta$payee_owner))))
names(payee_owner) <- x
# own accounts
x <- sort(unique(pa$account_id[pa$account_id %in% ta$payor_id]))
payor_pa <- lapply(x, function(x) x == ta$payor_id)
names(payor_pa) <- x
x <- sort(unique(pa$account_id[pa$account_id %in% ta$payee_id]))
payee_pa <- lapply(x, function(x) x == ta$payee_id)
names(payee_pa) <- x
# reference
reference <- gsub("[^a-z ]", "", tolower(ta$reference))
x <- sort(unique(unlist(strsplit(reference, " "))))
reference <- lapply(x, function(x) grepl(x, reference))
names(reference) <- x
# entry
entry <- gsub("[^a-z ]", "", tolower(ta$entry))
x <- sort(unique(unlist(strsplit(entry, " "))))
entry <- lapply(x, function(x) grepl(x, entry))
names(entry) <- x
# value
print(ta$value)
ta$value <- as.integer(ta$value)
return(ta$value)
value <- list(mod5 = ta$value %% 500 == 0, mod50 = ta$value %% 5000 == 0, mod100 = ta$value %% 10000 == 0, ge100 = ta$value >= 10000)
# return feature list and abt
feats <- c( "payor_country", "payee_country", "payor_bank", "payee_bank", "payor_owner", "payee_owner", "payor_pa", "payee_pa",
"reference", "entry", "value")
features <- data.frame( name = unlist(lapply( feats, function(x) rep(x, length(get(x, envir = env))) )),
value = unlist(lapply( feats, function(x) names(get(x, envir = env)) )) )
abt <- do.call(cbind, unlist(lapply(feats, get, envir = env), recursive = FALSE))
colnames(abt) <- paste(features$name, features$value, sep = ":")
mode(abt) <- "integer"
class(abt) <- "ABT"
class(features) <- "FeatureList"
return(list(ABT = abt, FeatureList = features))
}
res <- FeatureExtraction(df, df2)
res
factor(c("500", "1000"))
as.integer(factor(c("500", "1000")))
as.integer(as.character(factor(c("500", "1000"))))
FeatureExtraction <- function( ta, pa )
{
env <- environment()
# country code
x <- sort(unique(strtrim(gsub("[^0-9a-z]", "", tolower(ta$payor_iban)), width = 2)))
payor_country <- lapply(x, function(x) grepl(x, gsub("[^0-9a-z]", "", tolower(ta$payor_iban))))
names(payor_country) <- x
x <- sort(unique(strtrim(gsub("[^0-9a-z]", "", tolower(ta$payee_iban)), width = 2)))
payee_country <- lapply(x, function(x) grepl(x, gsub("[^0-9a-z]", "", tolower(ta$payee_iban))))
names(payee_country) <- x
# bank code
x <- sort(unique(strtrim(gsub("[^0-9a-z]", "", tolower(ta$payor_bic)), width = 4)))
payor_bank <- lapply(x, function(x) grepl(x, gsub("[^0-9a-z]", "", tolower(ta$payor_bic))))
names(payor_bank) <- x
x <- sort(unique(strtrim(gsub("[^0-9a-z]", "", tolower(ta$payee_bic)), width = 4)))
payee_bank <- lapply(x, function(x) grepl(x, gsub("[^0-9a-z]", "", tolower(ta$payee_bic))))
names(payee_bank) <- x
# owners
x <- sort(unique(gsub("[^a-z0-9 ]", "", tolower(ta$payor_owner))))
payor_owner <- lapply(x, function(x) grepl(tolower(x), gsub("[^a-z 0-9]", "", tolower(ta$payor_owner))))
names(payor_owner) <- x
x <- sort(unique(gsub("[^a-z0-9 ]", "", tolower(ta$payee_owner))))
payee_owner <- lapply(x, function(x) grepl(tolower(x), gsub("[^a-z 0-9]", "", tolower(ta$payee_owner))))
names(payee_owner) <- x
# own accounts
x <- sort(unique(pa$account_id[pa$account_id %in% ta$payor_id]))
payor_pa <- lapply(x, function(x) x == ta$payor_id)
names(payor_pa) <- x
x <- sort(unique(pa$account_id[pa$account_id %in% ta$payee_id]))
payee_pa <- lapply(x, function(x) x == ta$payee_id)
names(payee_pa) <- x
# reference
reference <- gsub("[^a-z ]", "", tolower(ta$reference))
x <- sort(unique(unlist(strsplit(reference, " "))))
reference <- lapply(x, function(x) grepl(x, reference))
names(reference) <- x
# entry
entry <- gsub("[^a-z ]", "", tolower(ta$entry))
x <- sort(unique(unlist(strsplit(entry, " "))))
entry <- lapply(x, function(x) grepl(x, entry))
names(entry) <- x
# value
ta$value <- as.integer(as.character(ta$value))
value <- list(mod5 = ta$value %% 500 == 0, mod50 = ta$value %% 5000 == 0, mod100 = ta$value %% 10000 == 0, ge100 = ta$value >= 10000)
# return feature list and abt
feats <- c( "payor_country", "payee_country", "payor_bank", "payee_bank", "payor_owner", "payee_owner", "payor_pa", "payee_pa",
"reference", "entry", "value")
features <- data.frame( name = unlist(lapply( feats, function(x) rep(x, length(get(x, envir = env))) )),
value = unlist(lapply( feats, function(x) names(get(x, envir = env)) )) )
abt <- do.call(cbind, unlist(lapply(feats, get, envir = env), recursive = FALSE))
colnames(abt) <- paste(features$name, features$value, sep = ":")
mode(abt) <- "integer"
class(abt) <- "ABT"
class(features) <- "FeatureList"
return(list(ABT = abt, FeatureList = features))
}
res <- FeatureExtraction(df, df2)
feats <- res$FeatureList
abt <- res$ABT
abt
100000 %% 500 == 0
exp <- cbind(c(1,0,0,1), c(0,1,0,0), c(0,0,1,0))
exp
exp <- cbind(exp, exp)
exp
exp <- cbind(exp, matrix(1,4,4), c(1,0,0,0), c(0,0,0,1), c(1,0,0,1), c(0,1,1,0), c(1,0,0,1), c(0,1,1,0),
c(1,1,0,1), c(0,1,0,1), c(0,1,0,1), c(0,1,1,0))
exp
exp == abt
expect_equal(exp, abt)
abt <- as.matrix(res$ABT)
abt
abt <- matrix(res$ABT, 4, 20)
abt
expect_equal(exp, abt)
test_that("Feature Extraction", {
df <- data.frame(
payor_id = 1:4, payor_owner = rep("a\\s[] d:.", 4), payor_iban = c("D\\E000342", "ENasd/;:.,", "es1234", "_d-#üäeö"), payor_bic = rep("as\\Df_`\\[]{}()"),
payee_id = 4:1, payee_owner = rep("a\\s[] d:.", 4), payee_iban = c("DE000342", "EN\\[]{}/()", "es1234", "d_e1~*#!$%"), payee_bic = rep("asDf&^°|<>"),
date = c("2010-1-1", "2010-01-01", "1990-1-1", "1990-01-01"),
reference = c("as_d üäö:,|as\\d_%&/´", "t_e;üsö:,|t\\_%$§/´", "test test", "asd"),
entry = c("as#'d üäö:^°as\\d_%&/´", "t_e(;))üsö:,|t\\_%$[§]/´", "test te{s}\\t", "asd"),
value = c("500", "10000", "50219", "0")
)
df2 <- data.frame(account_id = 1)
exp <- cbind(c(1,0,0,1), c(0,1,0,0), c(0,0,1,0))
exp <- cbind(exp, exp)
exp <- cbind(exp, matrix(1,4,4), c(1,0,0,0), c(0,0,0,1), c(1,0,0,1), c(0,1,1,0), c(1,0,0,1), c(0,1,1,0),
c(1,1,0,1), c(0,1,0,1), c(0,1,0,1), c(0,1,1,0))
res <- FeatureExtraction(df, df2)
feats <- res$FeatureList
abt <- matrix(res$ABT, 4, 20)
expect_equal(as.character(unique(feats$value[grepl("country", feats$name)])), c("de", "en", "es"))
expect_equal(as.character(unique(feats$value[grepl("owner", feats$name)])), "asd")
expect_equal(as.character(unique(feats$value[grepl("bank", feats$name)])), "asdf")
expect_equal(as.character(unique(feats$value[grepl("reference", feats$name)])), c("asd", "test"))
expect_equal(as.character(unique(feats$value[grepl("entry", feats$name)])), c("asd", "test"))
expect_equal(exp, abt)
})
expect_equal(as.character(unique(feats$value[grepl("owner", feats$name)])), "asd")
expect_equal(as.character(unique(feats$value[grepl("owner", feats$name)])), "asdd")
expect_equal(as.character(unique(feats$value[grepl("owner", feats$name)])), "as d")
test_that("Feature Extraction", {
df <- data.frame(
payor_id = 1:4, payor_owner = rep("a\\s[] d:.", 4), payor_iban = c("D\\E000342", "ENasd/;:.,", "es1234", "_d-#üäeö"), payor_bic = rep("as\\Df_`\\[]{}()"),
payee_id = 4:1, payee_owner = rep("a\\s[] d:.", 4), payee_iban = c("DE000342", "EN\\[]{}/()", "es1234", "d_e1~*#!$%"), payee_bic = rep("asDf&^°|<>"),
date = c("2010-1-1", "2010-01-01", "1990-1-1", "1990-01-01"),
reference = c("as_d üäö:,|as\\d_%&/´", "t_e;üsö:,|t\\_%$§/´", "test test", "asd"),
entry = c("as#'d üäö:^°as\\d_%&/´", "t_e(;))üsö:,|t\\_%$[§]/´", "test te{s}\\t", "asd"),
value = c("500", "10000", "50219", "0")
)
df2 <- data.frame(account_id = 1)
exp <- cbind(c(1,0,0,1), c(0,1,0,0), c(0,0,1,0))
exp <- cbind(exp, exp)
exp <- cbind(exp, matrix(1,4,4), c(1,0,0,0), c(0,0,0,1), c(1,0,0,1), c(0,1,1,0), c(1,0,0,1), c(0,1,1,0),
c(1,1,0,1), c(0,1,0,1), c(0,1,0,1), c(0,1,1,0))
res <- FeatureExtraction(df, df2)
feats <- res$FeatureList
abt <- matrix(res$ABT, 4, 20)
expect_equal(as.character(unique(feats$value[grepl("country", feats$name)])), c("de", "en", "es"))
expect_equal(as.character(unique(feats$value[grepl("owner", feats$name)])), "as d")
expect_equal(as.character(unique(feats$value[grepl("bank", feats$name)])), "asdf")
expect_equal(as.character(unique(feats$value[grepl("reference", feats$name)])), c("asd", "test"))
expect_equal(as.character(unique(feats$value[grepl("entry", feats$name)])), c("asd", "test"))
expect_equal(exp, abt)
})
devtools::install()
